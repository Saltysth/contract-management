<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.contract.management.infrastructure.mapper.ContractMapper">

    <!-- 结果映射 -->
    <resultMap id="ContractEntityResultMap" type="com.contract.management.infrastructure.entity.ContractEntity">
        <id column="id" property="id"/>
        <result column="contract_name" property="contractName"/>
        <result column="contract_type" property="contractType"/>
        <result column="contract_status" property="contractStatus"/>
        <result column="party_a_name" property="partyAName"/>
        <result column="party_a_contact" property="partyAContact"/>
        <result column="party_a_address" property="partyAAddress"/>
        <result column="party_b_name" property="partyBName"/>
        <result column="party_b_contact" property="partyBContact"/>
        <result column="party_b_address" property="partyBAddress"/>
        <result column="contract_amount" property="contractAmount"/>
        <result column="sign_date" property="signDate"/>
        <result column="effective_date" property="effectiveDate"/>
        <result column="expiry_date" property="expiryDate"/>
        <result column="attachment_uuid" property="attachmentUuid"/>
        <result column="tags" property="tags"/>
        <result column="description" property="description"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="object_version_number" property="objectVersionNumber"/>
        <result column="is_deleted" property="isDeleted"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, contract_name, contract_type, contract_status,
        party_a_name, party_a_contact, party_a_address,
        party_b_name, party_b_contact, party_b_address,
        contract_amount, sign_date, effective_date, expiry_date,
        attachment_uuid, tags, description,
        created_by, updated_by, created_time, updated_time,
        object_version_number, is_deleted
    </sql>

    <!-- 复杂条件分页查询 -->
    <select id="selectByFilters" resultMap="ContractEntityResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM contract
        <where>
            is_deleted = false
            <if test="contractType != null and contractType != ''">
                AND contract_type = #{contractType}
            </if>
            <if test="contractStatus != null and contractStatus != ''">
                AND contract_status = #{contractStatus}
            </if>
            <if test="createdBy != null">
                AND created_by = #{createdBy}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                contract_name ILIKE CONCAT('%', #{keyword}, '%')
                OR description ILIKE CONCAT('%', #{keyword}, '%')
                OR party_a_name ILIKE CONCAT('%', #{keyword}, '%')
                OR party_b_name ILIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="startDate != null">
                AND created_time &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND created_time &lt;= #{endDate}
            </if>
        </where>
        ORDER BY created_time DESC
    </select>

</mapper>